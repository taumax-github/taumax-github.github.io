<!DOCTYPE html>

<html lang="ja">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="ITエンジニアがこれまで学んだことを整理するサイト" />
    <meta name="keywords" content="IT,エンジニア">

    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="../../../css/print.css" media="print">
    <script src="../../../js/openclose.js"></script>

    <title>https化</title>
    
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <style>
      .menu1 a {background-position: -10px -10px;}
      .menu2 a {background-position: -10px -130px;}
      .menu3 a {background-position: -10px -250px;}
      .menu4 a {background-position: -10px -370px;}
      .menu5 a {background-position: -10px -490px;}
    </style>
    <![endif]-->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141266564-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-141266564-1');
    </script>
    <script data-ad-client="ca-pub-5924490903263360" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <!--PC用（801px以上端末）で表示させるブロック-->
  <header class="pc">
    <h1 class="logo">
      <a href="https://taumax-github.github.io/"><img src="../../../images/icon_twitter_card.png" alt="TOP"></a>
    </h1>

    <!--PC用（801px以上端末）メニュー-->
    <nav id="menubar">
      <ul class="none">
        <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
      </ul>
    </nav>
    <ul class="icon">
      <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../images/icon_twitter.png" alt="Twitter"></a></li>
      <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../images/icon_qiita.png" alt="Qiita"></a></li>
    </ul>
    <nav>
      <ul class="indent_no">
        <li><a href="#summary">概要</a></li>
        <li><a href="#whatimade">作成物</a></li>
        <li><a href="#mechanism">仕組み</a></li>
        <li><a href="#whatilearn">学び</a></li>
      </ul>
    </nav>
  </header><!--/.pc-->

  <!--小さな端末用（800px以下端末）で表示させるブロック-->
  <header class="sh">
    <h1 class="logo">
      <a href="https://taumax-github.github.io/"><img src="../../../images/icon_twitter_card.png" alt="SAMPLE SITE"></a>
    </h1>

    <!--小さな端末用（800px以下端末）メニュー-->
    <div id="menubar-s">
      <nav>
        <ul class="none">
          <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
        </ul>
      </nav>
      <ul class="icon">
        <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../images/icon_twitter.png" alt="Twitter"></a></li>
        <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../images/icon_qiita.png" alt="Qiita"></a></li>
      </ul>
      <nav>
        <ul class="indent_no">
          <li><a href="#summary">概要</a></li>
          <li><a href="#whatimade">作成物</a></li>
          <li><a href="#mechanism">仕組み</a></li>
          <li><a href="#whatilearn">学び</a></li>
        </ul>
      </nav>
    </div><!--/#menubar-s-->
  </header><!--/.sh-->

  <body class="defaultbody">
    <div id="container">
    <div id="contents">
    <div id="main">
      <span id="pagetop"></span>
      <section class="box">
        <h2 class="title">コンテナ化</h2>
        <!-- tweetボタン -->
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        <!-- はてぶボタン -->
        <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        <!-- はてぶボタン
        <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-normal" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        -->

      <br><br>
      <p style="color: #FFFFFF;"><a href="../bymyself.html" style="color: #00bfff;">タイトル考え中</a> > https化</p>

      <div id="summary"></div>
      <h3 class="title">https化</h3>
      <p>
        https化してみたかった。<br>
      </p>

      <br>
      <div id="whatimade"></div>
      <h3 class="title">作ったもの（実際に稼働したときのツイート）</h3>
      <p>
        内容は対応前後で変化なし。<br>
      </p>

      <br><br>
      <div id="mechanism"></div>
      <h3 class="title">どんな仕組み？</h3>
      <p>
        <font color="yellow">以下のサイトの手順に従えばある程度できたが、それぞれの手順が何をしているのかよくわかっていない部分があるので明日以降整理したい</font><br>
        <a href="https://qiita.com/yoshizaki_91/items/e6f39a5bfb99900b44b2" target="_blank">さくらVPSにSSL証明書を導入しHTTPS通信の構築</a>
      </p>

      <br><br>
      <div id="whatilearn"></div>
      <h3 class="title">ぶつかった壁とか学んだこととか</h3>
      <h4 class="title">httpd 起動時にエラー</h4>
      <div class="code">
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp httpd[19419]: [Mon Dec 27 09:13:07.298143 2021] [so:warn] [pid 19419] AH01574: module ssl_module is already loaded, skipping<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp httpd[19419]: AH00548: NameVirtualHost has no effect and will be removed in the next release /etc/httpd/conf.d/vhost.conf:4<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp httpd[19419]: <font color="red">AH00526: Syntax error on line 9 of /etc/httpd/conf.d/vhost.conf:</font><br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp httpd[19419]: <font color="red">Invalid command 'SSLMutex', perhaps misspelled or defined by a module not included in the server configuration</font><br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp kill[19421]: kill: cannot find process ""<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: control process exited, code=exited status=1<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Failed to start The Apache HTTP Server.<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Unit httpd.service entered failed state.<br>
        12月 27 09:13:07 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service failed.<br>
      </div>
      <br>
      <a href="http://hideaki-momose.blogspot.com/2014/04/apache_9.html" target="_blank">Apache2.4.x SSLMutexが廃止</a>されたらしい。「/etc/httpd/conf.d/vhost.conf」の「SSLMutex default」をコメントアウトして「Mutex default ssl-cache」に修正。<br>

      <br>
      <div class="code">
        12月 27 09:40:50 ik1-344-32350.vs.sakura.ne.jp httpd[19643]: AH00548: NameVirtualHost has no effect and will be removed in the next release /etc/httpd/conf.d/vhost.conf:4<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp httpd[19643]: (98)Address already in use: AH00072: make_sock: could not bind to address 0.0.0.0:443<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp httpd[19643]: no listening sockets available, shutting down<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp httpd[19643]: <font color="red">AH00015: Unable to open logs</font><br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp kill[19645]: kill: cannot find process ""<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: control process exited, code=exited status=1<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Failed to start The Apache HTTP Server.<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Unit httpd.service entered failed state.<br>
        12月 27 09:40:51 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service failed.<br>
      </div>

      <br>
      <font color="yellow">修正前がわからん</font>
      「/etc/httpd/conf.d/vhost.conf」のCustomLogとErrorLogを修正を修正。「CustomLog /etc/httpd/logs/ssl_request_log」、「ErrorLog  /etc/httpd/logs/ssl_error_log」<br>

      <div class="code">
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp httpd[19750]: [Mon Dec 27 09:54:23.644037 2021] [so:warn] [pid 19750] AH01574: module ssl_module is already loaded, skipping<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp httpd[19750]: AH00548: NameVirtualHost has no effect and will be removed in the next release /etc/httpd/conf.d/vhost.conf:4<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp httpd[19750]: AH00526: Syntax error on line 24 of /etc/httpd/conf.d/vhost.conf:<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp httpd[19750]: <font color="red">CustomLog takes two or three arguments, a file name, a custom log format string or format name, and an optional "env=" or "expr=" clause (see docs)</font><br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp kill[19751]: kill: cannot find process ""<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: control process exited, code=exited status=1<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Failed to start The Apache HTTP Server.<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Unit httpd.service entered failed state.<br>
        12月 27 09:54:23 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service failed.
      </div>

      <br>
      「/etc/httpd/conf.d/vhost.conf」のCustomLogとErrorLogを修正を修正。「CustomLog /var/log/httpd/ssl_access_log "%h %l %u %t \"%r\" %>s %b"」、「ErrorLog  /var/log/httpd/ssl_error_log」<br>

      <br>
      参考<br>
      <ul>
        <li><a href="https://www.javadrive.jp/apache/log/index1.html" target="_blank">CustomLogディレクティブ：ログファイルの名前と使用するフォーマットを選択する</a></li>
        <li><a href="https://httpd.apache.org/docs/2.4/ja/mod/mod_log_config.html" target="_blank">Apache モジュール mod_log_config</a></li>
      </ul>

      <br>
      <div class="code">
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp httpd[20113]: AH00548: NameVirtualHost has no effect and will be removed in the next release /etc/httpd/conf.d/vhost.conf:4<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp httpd[20113]: <font color="red">(98)Address already in use: AH00072: make_sock: could not bind to address 0.0.0.0:443</font><br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp httpd[20113]: no listening sockets available, shutting down<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp httpd[20113]: <font color="red">AH00015: Unable to open logs</font><br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp kill[20115]: kill: cannot find process ""<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: control process exited, code=exited status=1<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Failed to start The Apache HTTP Server.<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Unit httpd.service entered failed state.<br>
        12月 27 10:48:39 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service failed.<br>
      </div>

      <br>
      エラーの内容は変わったけど相変わらずログが読めないと言っている。<br>
      エラーは二つ。<br>
      ・AH00072: make_sock: could not bind to address 0.0.0.0:443<br>
      ・AH00015: Unable to open logs<br>
      一旦ログは置いておいて１つ目の方の対処<br>
      443 portを複数プロセスがlistenしていると起きるみたい。<br>
      /etc/httpd/conf.d/ssl.confに「Listen 443 https」とあるのでssl.confをどかしてみた。<br>
      ・・・が、うまく動かず、最終的には、ssl.confの「Listen 443 https」を復活させ、「vhost.conf」を消した。<br>
      ssl.confにもSSLCertificateFile, SSLCertificateKeyFile, SSLCertificateChainFile と ServerName を設定。<br>
      ・SSLCertificateFile /etc/httpd/conf/ssl.crt/server.crt<br>
      ・SSLCertificateKeyFile /etc/httpd/conf/ssl.key/server.key<br>
      ・SSLCertificateChainFile /etc/httpd/conf/ssl.crt/internal.cer<br>
      ・ServerName sagamax.cyou:443<br>
      
      ログも出力されるようになった。<br>

      <br>
      参考<br>
      <ul>
        <li><a href="https://www.javadrive.jp/apache/log/index1.html" target="_blank">CustomLogディレクティブ：ログファイルの名前と使用するフォーマットを選択する</a></li>
        <li><a href="https://httpd.apache.org/docs/2.4/ja/mod/mod_log_config.html" target="_blank">Apache モジュール mod_log_config</a></li>
        <li><a href="https://hyhyhy.muragon.com/entry/19.htmlhttps://hyhyhy.muragon.com/entry/19.html" target="_blank">ApacheのupdateによるSSLの設定変更</a></li>
        <li><a href="http://hideaki-momose.blogspot.com/2014/04/apache_9.html" target="_blank">apache インストール/設定 メモ</a></li>
        <li><a href="https://qiita.com/yoshizaki_91/items/e6f39a5bfb99900b44b2" target="_blank">さくらVPSにSSL証明書を導入しHTTPS通信の構築</a></li>
        <li><a href="https://help.sakura.ad.jp/ssl/2327/" target="_blank">CSRを作成したい</a></li>
      </ul>

      <div class="code">
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp httpd[20545]: In order to read them you have to provide the pass phrases.<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp httpd[20545]: Server sagamax.cyou:443 (RSA)<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp httpd[20545]: <font color="red">Enter pass phrase:Apache:mod_ssl:Error: Private key not found.</font><br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp httpd[20545]: **Stopped<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp kill[20547]: kill: cannot find process ""<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service: control process exited, code=exited status=1<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Failed to start The Apache HTTP Server.<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp systemd[1]: Unit httpd.service entered failed state.<br>
        12月 27 11:14:38 ik1-344-32350.vs.sakura.ne.jp systemd[1]: httpd.service failed.<br>
      </div>
      パスワードを対話入力することすらなくエラー。<br>
      SSLCertificateKeyFile, SSLCertificateFileのパスはあってる。<br>
      server_****.keyのパスフレーズ解除してみる（<a href="https://ja.stackoverflow.com/questions/55163/centos7-apache%E3%81%AB%E8%A4%87%E6%95%B0ssl%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%89%E5%86%8D%E8%B5%B7%E5%8B%95%E3%82%A8%E3%83%A9%E3%83%BC" target="_blank">参考</a>）。<br>
      「openssl rsa -in /etc/httpd/conf/ssl.key/server.key -out /etc/httpd/conf/ssl.key/server.key」<br>
      正常にhttpdが立ち上がるようになった。<br>

      <br><br>
      <h4 class="title">url打ってアクセスしようとしたが、タイムアウトでエラーになる。。。</h4>
      以下の画面が出てきてアクセスできない<br>
      <img src="img/timeout.png" width="500"><br>

      <br>
      firewallの設定<br>
      <div class="codetitle">firewall-cmd --list-all</div>
      <div class="code">
        public (active)<br>
        target: default<br>
        icmp-block-inversion: no<br>
        interfaces: eth0<br>
        sources:<br>
        <font color="red">services: dhcpv6-client http ssh</font><br>
        ports: 8009/tcp 8009/udp<br>
        protocols:<br>
        masquerade: no<br>
        forward-ports:<br>
        source-ports:<br>
        icmp-blocks:<br>
        rich rules:<br>
      </div>
      services に https がない<br>

      <br>
      <div class="codetitle">firewall-cmd --zone=public --add-service=https --permanent</div>
      <div class="codetitle">firewall-cmd --list-all</div>
      <div class="code">
        public (active)<br>
        target: default<br>
        icmp-block-inversion: no<br>
        interfaces: eth0<br>
        sources:<br>
        <font color="red">services: dhcpv6-client http ssh</font><br>
        ports: 8009/tcp 8009/udp<br>
        protocols:<br>
        masquerade: no<br>
        forward-ports:<br>
        source-ports:<br>
        icmp-blocks:<br>
        rich rules:<br>
      </div>

      <br>
      まだ追加されていない。firewall 再起動<br>
      <div class="codetitle">firewall-cmd --reload</div>
      <div class="codetitle">firewall-cmd --list-all</div>
      <div class="code">
        public (active)<br>
        target: default<br>
        icmp-block-inversion: no<br>
        interfaces: eth0<br>
        sources:<br>
        <font color="red">services: dhcpv6-client http https ssh</font><br>
        ports: 8009/tcp 8009/udp<br>
        protocols:<br>
        masquerade: no<br>
        forward-ports:<br>
        source-ports:<br>
        icmp-blocks:<br>
        rich rules:<br>
      </div>
      https が追加されたので再度画面表示したら動いた。<br>

      <br><br>
      参考<br>
      <ul>
        <li><a href="https://teratail.com/questions/145713" target="_blank">httpsでの接続がタイムアウトになります</a></li>
        <li><a href="https://adan.jp.net/blog/programing/1242" target="_blank">CentOS7のfirewalldにhttpとhttpsサービスを許可（Apacheへの外部からのアクセスを許可）する</a></li>
      </ul>

    </section><!-- section class="box" -->

    <footer>
      <small><a href="https://taumax-github.github.io/">とあるＩＴエンジニアの知識整理</a> All Rights Reserved.</small>
      <span class="pr"><a href="https://template-party.com/" target="_blank">《Web Design:Template-Party》</a></span>
    </footer>

    </div><!--/#main-->
    </div><!--/#contents-->
    </div><!--/#container-->
  </body>

  <!--ページの上部に戻る「↑」ボタン-->
  <p class="nav-fix-pos-pagetop"><a href="#pagetop">↑</a></p>

  <!--メニュー開閉ボタン-->
  <div id="menubar_hdr" class="close"></div>

  <!--メニューの開閉処理条件設定　800px以下-->
  <script>
    if (OCwindowWidth() <= 800) {
      open_close("menubar_hdr", "menubar-s");
    }
  </script>
</html>
