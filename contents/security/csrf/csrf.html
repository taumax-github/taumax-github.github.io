<!DOCTYPE html>

<html lang="ja">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="../../../css/print.css" media="print">
    <script src="../../../js/openclose.js"></script>

    <title>とあるＩＴエンジニアの知識整理</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141266564-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-141266564-1');
    </script>
    <script data-ad-client="ca-pub-5924490903263360" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <!--PC用（801px以上端末）で表示させるブロック-->
  <header class="pc">
    <h1 class="logo">
      <a href="https://taumax-github.github.io/"><img src="../../../images/icon_twitter_card.png" alt="TOP"></a>
    </h1>

    <!--PC用（801px以上端末）メニュー-->
    <nav id="menubar">
      <ul class="none">
        <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
      </ul>
    </nav>
    <ul class="icon">
      <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../images/icon_twitter.png" alt="Twitter"></a></li>
      <li><a href="https://togetter.com/id/taumax_" target="_blank"><img src="../../../images/icon_togetter.png" alt="togetter"></a></li>
      <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../images/icon_qiita.png" alt="Qiita"></a></li>
    </ul>
  </header><!--/.pc-->

  <!--小さな端末用（800px以下端末）で表示させるブロック-->
  <header class="sh">
    <!--小さな端末用（800px以下端末）メニュー-->
    <div id="menubar-s">
      <h1 class="logo">
        <a href="https://taumax-github.github.io/"><img src="../../../images/icon_twitter_card.png" alt="SAMPLE SITE"></a>
      </h1>
      <nav>
        <ul class="none">
          <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
        </ul>
      </nav>
      <ul class="icon">
        <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../images/icon_twitter.png" alt="Twitter"></a></li>
        <li><a href="https://togetter.com/id/taumax_" target="_blank"><img src="../../../../images/icon_togetter.png" alt="togetter"></a></li>
        <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../images/icon_qiita.png" alt="Qiita"></a></li>
      </ul>
    </div><!--/#menubar-s-->
  </header><!--/.sh-->

  <body class="defaultbody">
    <div id="container">
    <div id="contents">
    <div id="main">
      <span id="pagetop"></span>
      <section class="box">
        <!-- tweetボタン -->
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        <!-- はてぶボタン -->
        <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        <!-- はてぶボタン
        <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-normal" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        -->
        <h2 class="title">とあるＩＴエンジニアの知識整理</h2>

      <dt>
        クロスサイトリクエストフォージェリ(CSRF:Cross-Site Request Forgeries)
      </dt>
      <dd>
        <p>
          情報処理試験のセキュリティスペシャリスト（現：情報処理安全確保支援士）の<a href="https://www.jitec.ipa.go.jp/1_04hanni_sukiru/mondai_kaitou_2016h28.html#28haru" target="_blank">平成28年春　午後Ⅰ問1</a>でも出題されています。<br>
        </p>
        <p>
        <dt style="padding-left:1em">
          ◆CSRF攻撃を受けるどういった被害に合うのか？<br>
        </dt>
      </dd>
      <dd>
          CSRF攻撃は、ログインが必要なWebサービスにログインユーザーに成りすましたリクエストを送信する攻撃です。<br>
          この攻撃を受けると、身に覚えのないコメントを投稿されたり、非公開に設定していた情報を公開に変更されるなどの被害を受ける可能性があります。<br>
          CSRF攻撃が成立するまでの流れは以下の図のようになっています。<br>
          <img src="CSRF_flow.png" alt="CSRF攻撃が成立するまで（全体の流れ）" title="CSRF攻撃が成立するまで（全体の流れ）" width="70%" height="70%"><br><br>
        <p>
          Forgeriesは"偽造"という意味です。つまり「クロスサイトリクエストフォージェリ」を日本語に訳すと「サイトを跨いだ偽造リクエスト」です。
          上記の図では、罠サイトからSNSなどのWebサイトへサイトを跨いでおり、偽造されたリクエストが送信されています。<br>
        </p>
          上記のWebサイト部分を少し具体化した流れは以下の通りです。<br>
          本来であれば(a) ユーザ認証→(b) 商品の選択→(c) 商品の注文→(d) 注文内容の確認→(e) 注文の確定という画面遷移を経て商品を購入するWebサイトを想定します。<br>
          このサイトのWebアプリケーションにCSRFの脆弱性があった場合、当該サイトの利用者が、ログイン状態を保持したまま外部のWebサイトに置かれた(e)の画面への不正なリンクを押下することにより、意図しない商品を注文させられてしまう可能性があります。<br>
          下図の例の他、CSRFにより、パスワードを強制的に変更させられる、会員制サービスから強制的に退会させられる、ブログや掲示板に意図しないメッセージを書き込まされる、等の問題が発生する可能性があります。<br>
          <img src="CSRF_flowDetail.png" alt="CSRF攻撃が成立するまで（詳細）" title="CSRF攻撃が成立するまで（詳細）" width="70%" height="70%"><br>
        </p>
        <p>
          <dt style="padding-left:1em">
            ◆なぜこのようなことが起きてしまうのか？<br>
          </dt>
          <dd>
            図. CSRF攻撃が成立するまでの流れを見ると、別ドメインからのリクエストをWebサイトが受け取って処理していることに問題がありそうに見えますが、これは<a href="../SOP/SOP.html">SOP(Same-Origin Policy：同一生成元ポリシー)</a>の仕様です。ここは問題ありません。<br>
            問題は、利用者が意図したリクエストかどうかをWebサイトが識別できていないことです。（参考書籍1 P113）<br>
          </dd>
        </p>
        <p>
          <dt style="padding-left:1em">
            ◆どのようなWebサイトで注意が必要なのか？<br>
          </dt>
          <dd>
            フォームと呼ばれる機能を持っているWebサイトは注意が必要です。特に掲示板や、コメントを入力できるようなWebサイトはCSRF対策が必須になります。<br>
          </dd>
        </p>
        <p>
          <dt style="padding-left:1em">
            ◆対策<br>
          </dt>
          <dd>
          <p>
            - サイトを公開している人<br>
          </p>
          <p style="padding-left:1em">
            ・CSRF脆弱性に利用されやすい機能を停止する<br>
          </p>
          <p style="padding-left:2em">
            CSRF脆弱性の危険があるのは掲示板やコメントフォームなど、「閲覧者が情報を書き込める機能」です。<br>
            その機能が必須でない場合は、一時的にその機能を無効にしてしまうことで、被害を未然に防げます。<br>
          </p>
          <p style="padding-left:1em">
            ・コメント承認機能などがある場合はそれを有効にする<br>
          </p>
          <p style="padding-left:2em">
            また、コメントや意見を書き込む機能には、その情報をWebサイトに表示する前に管理者が確認する機能がついている場合もあります。<br>
            そのような機能がある場合は、承認機能を有効にし、未承認の書き込みについてはWebサイトに反映させないようにしましょう。<br>
          </p>
          <p style="padding-left:1em">
            ・プログラムの改修<br>
          </p>
          <p style="padding-left:2em">
            1. CSRF攻撃は、Cookieだけでセッションを維持している場合に発生する脆弱性を突いた攻撃です。<br>
            CookieはWebブラウザが自動で送信するため、Cookieに補完されたパラメタを確認するだけでは不十分です。<br>
            Cookieのパラメタが正しくても、利用者の意図したリクエストではない可能性があります。<br>
            対策としては、Cookie以外の情報を使って、利用者の意図したリクエストであることを確認する必要があります。<br>
            具体的には、利用者の要求（コメントの登録や利用者の登録情報の修正など）を確定する画面（確認画面）に遷移する前の画面（注文確定前の確認画面（画面(d)））に、<br>
            第三者が推測困難なランダムな値（トークン）を、hiddenフィールドの値として埋め込みます。<br>
            なお、Referrerログから秘密情報が漏えいしないように、この一連の処理にはPOSTメソッドを使用する必要があります。<br>
            セッションID等の秘密情報を埋め込む場合もあります。<br>
            そして、画面遷移後に受信したデータが、埋め込んだデータと一致するかを確認します。<br>
            一致しない場合は不正な画面遷移が発生したとして処理を中止します。（参考書籍1 P123、参考書籍2 P205）<br>
          </p>
          <p style="padding-left:2em">
            2. 確定処理の直前で再度パスワードを入力させる。（参考書籍2 P205）<br>
            (d)の画面で利用者に再度パスワードの入力を求め、(e)では入力されたパスワードが正しい場合のみ処理を実行するようにする。<br>
            これにより、パスワード入力のない注文確定リクエストを排除することが可能となる。<br>
            なお、この対策は上記に比べて実装が容易である反面、利用者の負担を増やすことになるという問題がある。<br>
          </p>
          <p style="padding-left:2em">
            3. Referrerを用いてリンク元の正当性を確認する。（参考書籍2 P205）<br>
            (e)のリクエストのReferrer情報を確認することで、不正なサイトから送られてきたリクエストを排除することが可能になる。<br>
            ただし、クライアントの設定などでReferrer情報を送付しないようにしている場合には、正当なリクエストであっても排除されてしまうことになる。<br>
          </p>
          <p style="padding-left:2em">
            4. 重要な操作を行った後で、その内容を登録アドレスにメール送信する。（参考書籍2 P205）<br>
            CSRFの被害を防ぐことにはならないが、攻撃があった事実を利用者に気づかせることができる。<br>
            ただし、メールの本文に重要な情報を入れないようにする等の注意が必要である。<br>
          </p>
          <p>
            - サイトにアクセスする人<br>
          </p>
        </p>
        <p>
          <dt style="padding-left:1em">
            ◆実際に起こった事例<br>
          </dt>
          <dd>
            <a href="https://www.itmedia.co.jp/enterprise/articles/0504/23/news005.html" target="_blank">大量の「はまちちゃん」を生み出したCSRFの脆弱性とは？</a><br>
          </dd>
          <dt style="padding-left:1em">
            ◆参考にしたサイト<br>
          </dt>
          <dd>
            <a href="https://www.scutum.jp/information/web_security_primer/csrf.html" target="_blank">CSRF（クロスサイトリクエストフォージェリ：リクエスト強要）って一体何？ - サイト運営者のためのWebサイトセキュリティ対策入門</a><br>
            <a href="http://www.tohoho-web.com/ex/same-origin-policy.html" target="_blank">同一生成元ポリシー(Same-Origin Policy)</a><br>
            <a href="http://watanabe-tsuyoshi.hatenablog.com/entry/2015/03/04/123649" target="_blank">Cross-Site Request Forgery（クロスサイトリクエストフォジェリー）って何？</a><br>
            <a href="https://www.1-firststep.com/archives/4961" target="_blank">クロスサイト・リクエストフォージェリ(CSRF)攻撃とは何かを解説</a><br>
            <a href="https://www.ipa.go.jp/security/vuln/vuln_contents/csrf.html" target="_blank">3. CSRF (クロスサイト・リクエスト・フォージェリ)</a><br>
            <a href="https://www.shadan-kun.com/blog/measure/2640/" target="_blank">CSRF（クロスサイトリクエストフォージェリ）の意味とその対策<a><br>
          </dd>
          <dt style="padding-left:1em">
            ◆参考にした書籍<br>
          </dt>
          <dd>
            1. <a href="https://www.amazon.co.jp/dp/4822237842" target="_blank">絶対わかるセスペ28春 2016年秋版</a><br>
            　※上記1.の2018年度版は<a href="https://www.amazon.co.jp/dp/4822257835" target="_blank">こちら（絶対わかる情報処理安全確保支援士 2018年春版）</a><br>
            <a target="_blank"  href="https://www.amazon.co.jp/gp/product/B079RSQVLJ/ref=as_li_tl?ie=UTF8&camp=247&creative=1211&creativeASIN=B079RSQVLJ&linkCode=as2&tag=sagamax-22&linkId=9b45769cb3cf939d821202f406d187d8"><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B079RSQVLJ&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=sagamax-22" ></a><br>
            2. <a href="https://www.amazon.co.jp/dp/4798143197" target="_blank">情報処理教科書 情報セキュリティスペシャリスト 2016年版</a><br>
            　※上記2.の2019年度版は<a href="https://www.amazon.co.jp/dp/479815928X" target="_blank">こちら（情報処理教科書 情報処理安全確保支援士 2019年版）</a><br>
            <a target="_blank"  href="https://www.amazon.co.jp/gp/product/479815928X/ref=as_li_tl?ie=UTF8&camp=247&creative=1211&creativeASIN=479815928X&linkCode=as2&tag=sagamax-22&linkId=22d87435b79b3533cd4db80ca4d42770"><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=479815928X&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=sagamax-22" ></a><br>
          </dd>
        </p>
      </dd>
    </dl>
      </section><!-- section class="box" -->

      <footer>
        <small><a href="https://taumax-github.github.io/">とあるＩＴエンジニアの知識整理</a> All Rights Reserved.</small>
        <span class="pr"><a href="https://template-party.com/" target="_blank">《Web Design:Template-Party》</a></span>
      </footer>

    </div><!--/#main-->
    </div><!--/#contents-->
    </div><!--/#container-->
  </body>

  <!--ページの上部に戻る「↑」ボタン-->
  <p class="nav-fix-pos-pagetop"><a href="#pagetop">↑</a></p>

  <!--メニュー開閉ボタン-->
  <div id="menubar_hdr" class="close"></div>
    <!--メニューの開閉処理条件設定　800px以下-->
    <script>
      if (OCwindowWidth() <= 800) {
        open_close("menubar_hdr", "menubar-s");
      }
    </script>
</html>
