<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="ITエンジニアがこれまで学んだことを整理するサイト" />
    <meta name="keywords" content="IT,エンジニア">

    <link rel="stylesheet" href="../../../../css/style.css">
    <link rel="stylesheet" href="../../../../css/print.css" media="print">
    <script src="../../../../js/openclose.js"></script>

    <title>Twitch × Twitter × Node.js</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141266564-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-141266564-1');
    </script>
    <script data-ad-client="ca-pub-5924490903263360" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <!--PC用（801px以上端末）で表示させるブロック-->
  <header class="pc">
    <h1 class="logo">
      <a href="https://taumax-github.github.io/"><img src="../../../../images/icon_twitter_card.png" alt="TOP"></a>
    </h1>

    <!--PC用（801px以上端末）メニュー-->
    <nav id="menubar">
      <ul class="none">
        <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
      </ul>
    </nav>
    <ul class="icon">
      <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../../images/icon_twitter.png" alt="Twitter"></a></li>
      <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../../images/icon_qiita.png" alt="Qiita"></a></li>
    </ul>
    <ul class="indent_no">
      <li><a href="#firstly">はじめに</a></li>
      <li><a href="#implementation">作った物</a></li>
      <li><a href="#register_application">アプリケーションの登録</a></li>
      <li><a href="#authentication">Twitch 認証</a></li>
      <li><a href="#user">Twitch の<br/>ユーザー</a></li>
      <li><a href="#tmijs">tmi.js × <br/>Node.js</a></li>
      <li><a href="#webhook">Webhook × <br/>Node.js</a></li>
      <li><a href="#api">API × <br/>Node.js</a></li>
      <li><a href="#twitter">twitter × <br/>Node.js</a></li>
      <li><a href="#obs">OBS × <br/>Node.js</a></li>
    </ul>
  </header><!--/.pc-->

  <!--小さな端末用（800px以下端末）で表示させるブロック-->
  <header class="sh">
    <!--小さな端末用（800px以下端末）メニュー-->
    <div id="menubar-s">
      <h1 class="logo">
        <a href="https://taumax-github.github.io/"><img src="../../../../images/icon_twitter_card.png" alt="SAMPLE SITE"></a>
      </h1>
      <nav>
        <ul class="none">
          <li class="menuimg menu1"><a href="https://taumax-github.github.io/"><span>Home</span></a></li>
        </ul>
      </nav>
      <ul class="icon">
        <li><a href="https://twitter.com/taumax_" target="_blank"><img src="../../../../images/icon_twitter.png" alt="Twitter"></a></li>
        <li><a href="https://qiita.com/taumax" target="_blank"><img src="../../../../images/icon_qiita.png" alt="Qiita"></a></li>
      </ul>
      <ul class="indent_no">
        <li><a href="#firstly">はじめに</a></li>
        <li><a href="#implementation">作った物</a></li>
        <li><a href="#register_application">アプリケーションの登録</a></li>
        <li><a href="#authentication">Twitch 認証</a></li>
        <li><a href="#user">Twitch のユーザー</a></li>
        <li><a href="#tmijs">tmi.js × Node.js</a></li>
        <li><a href="#webhook">Webhook × Node.js</a></li>
        <li><a href="#api">Twitch API</a></li>
        <li><a href="#twitter">X（旧twitter） × Node.js</a></li>
        <li><a href="#obs">OBS × Node.js</a></li>
      </ul>
    </div><!--/#menubar-s-->
  </header><!--/.sh-->

  <body class="defaultbody">
    <div id="container">
    <div id="contents">
    <div id="main">
      <span id="pagetop"></span>
      <section class="box">
        <!-- tweetボタン -->
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        <h2 class="title">Twitch × Twitter × Node.js</h2>

        <ul class="breadcrumb">
          <li class="breadcrumbli"><a href="../../../../index.html">ホーム</a></li>
          <li class="breadcrumbli"> > <a href="../js_index.html">js関連技術</a></li>
          <li class="breadcrumbli"> > <a href="./nodejs.html">Node.js</a></li>
          <li class="breadcrumbli"> > Twitch</li>
        </ul>

        <br/><br/>
        <span id="firstly"></span>
        <h3 class="title">はじめに</h3>
        <p>
          このページでは、自分が Node.js を使って実際に作った物について記載しています。<br/>
          <a href="./nodejs.html">Node.js</a>の記事を読んだ前提で書いています。今見ているこの頁の1階層上の記事です。<br/>
          EventEmitter という単語を見てピンと来ないようなら、<a href="./nodejs.html#async">非同期のイベント駆動型ランタイム</a>の部分だけでも読んでください。<br/>
        </p>

        <br/>
        <span id="implementation"></span>
        <h3 class="title">作った物</h3>
        <p>
          Twitch というプラットフォームを使ってゲームの配信をしているのですが、Node.jsを使ってbotを動かすなど、いろいろカスタマイズしています。そのシステム構成が以下の図。<br/>
          図右下の OBS Studio はゲーム配信するためのツールです。 <a href="https://github.com/obs-websocket-community-projects/obs-websocket-js" target="_blank" rel="noopener noreferrer">obs-websocket-js</a> というライブラリを使って、Node.js から WebSocket 経由で操作しています。<br/>
          <img src="./img/play_with_nodejs.jpg" width="800" /><br/>
        </p>

        <br/>
        カスタマイズの例<br/>
        <ol>
          <li>
            チャンネルポイント使用→webhook→チャット→OBS操作<br/>
            twitchにはチャンネルポイントという機能があり、（普通こんな使い方はしないのですが）使用されたら任意のサーバーに Webhook リクエストを飛ばすこともできます。<br/>
            サーバに Webhook が飛んで来たらそれに対応するメッセージをチャットに投げて、そのチャットをトリガーに EventEmitter でローカルの Node.js を稼働させ、WebSocket 経由で OBS を操作しています（下図の赤線の流れ）。<br/>
            <img src="./img/chanel_point.jpg" width="800" /><br/>

            <br/>
            以下がチャンネルポイントを使った例(2h9m35s頃)。 Webhook を受けて「やきつくしてさしあげますわ！」という台詞をbotが喋り、その台詞をトリガーにローカルの Node.js が稼働し、OBS を操作することで画面に炎を表示させたり、音声を流したりしています。<br/>
          </li>
          <iframe src="https://player.twitch.tv/?video=2098995290&time=2h9m35s&parent=taumax-github.github.io" frameborder="0" allowfullscreen="true" scrolling="no" height="378" width="620"></iframe>
          <li>
            配信開始→Webhook→twitter<br/>
            配信を開始した際にもWebhookリクエストを飛ばすことができるので、それをトリガーにX（旧twitter）に配信開始を告知する処理を稼働させています（下図の赤線の流れ）。<br/>
            <img src="./img/auto_post.jpg" width="800" /><br/>

            <br/>
            以下が実際のポスト。<br/>
          </li>
          <blockquote class="twitter-tweet"><p lang="ja" dir="ltr">twitch配信通知bot<br>twitchでロマサガ3配信中です！<br>お時間合う方是非遊びに来てみてくださーい。<br>▶️視聴はこちら：<a href="https://t.co/P46Z6JrYH1">https://t.co/P46Z6JrYH1</a><a href="https://twitter.com/hashtag/%E3%83%AD%E3%83%9E%E3%82%B5%E3%82%AC3?src=hash&amp;ref_src=twsrc%5Etfw">#ロマサガ3</a> <a href="https://twitter.com/hashtag/%E3%83%AC%E3%83%88%E3%83%AD%E3%82%B2%E3%83%BC%E3%83%A0?src=hash&amp;ref_src=twsrc%5Etfw">#レトロゲーム</a> <a href="https://twitter.com/hashtag/%E3%83%AC%E3%83%88%E3%83%AD%E3%82%B3%E3%83%B3%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%9E%E3%83%BC%E6%84%9B%E5%A5%BD%E4%BC%9A?src=hash&amp;ref_src=twsrc%5Etfw">#レトロコンシューマー愛好会</a> <a href="https://t.co/UeLX1jIXB8">pic.twitter.com/UeLX1jIXB8</a></p>&mdash; sagamax@サガとレトロゲー (@sagamax__) <a href="https://twitter.com/sagamax__/status/1708089149629301126?ref_src=twsrc%5Etfw">September 30, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </ol>

        <br/>
        以降、この中身がどうなっているのかについて説明していきます。<br/>

        <br/>
        <span id="register_application"></span>
        <h3 class="title">アプリケーションの登録</h3>
        <p>
          まず、Twitch の developers サイトでアプリケーションを登録する必要があります。<br/>
          以下リンク先から developers サイトにログイン。<br/>
          <a href="https://dev.twitch.tv/" target="_blank" rel="noopener noreferrer">Twitch developers</a><br/>
          右上の 「Your Console」 ボタンからコンソール画面に遷移して、「アプリケーションを登録」ボタンを押下。<br/>
          <img src="./img/console.jpg" width="500"/><br/>

          <br/>
          アプリケーション登録画面でアプリケーション名、リダイレクトURL、カテゴリーを入力。<br/>
          「新しい秘密」ボタンを押下すると秘密鍵が生成される。<br/>
          秘密鍵とクライアントIDを控えて「保存」ボタンを押下。<br/>
          <img src="./img/application_info.jpg" width="500"/><br/>
        </p>


        <br/>
        <span id="authentication"></span>
        <h3 class="title">Twitch の認証</h3>
        <p>
          まず Twitch の Webhook やAPIを使うためには、access token を取得する必要がある。<br/>
          access token には user access token と app access token の2種類があり、それぞれ用途は大雑把に以下の通り。<br/>
        </p>

        <ul>
          <li>
            <a href="https://dev.twitch.tv/docs/authentication/#user-access-tokens" target="_blank" rel="noopener noreferrer">User access tokens</a>：ユーザー認証が必要な機能を利用する場合に使用する token。<br/>
          </li>
          <li>
            <a href="https://dev.twitch.tv/docs/authentication/#app-access-tokens" target="_blank" rel="noopener noreferrer">App access tokens</a>：ユーザー認証が不要な機能を利用する場合に使用する token。<br/>
          </li>
        </ul>

        <p>
          access token を取得する方法は以下リンク先参照。<br/>
          <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth/" target="_blank" rel="noopener noreferrer">Getting OAuth Access Tokens</a><br/>

          <br/>
          4種類の token 取得方法があり、使用方法に応じて取得方法が変わります。<br/>
          今回自作したアプリケーションにおいては、以下2パターンを使用しています。<br/>
        </p>
        <ul>
          <li><a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth/#client-credentials-grant-flow" target="_blank" rel="noopener noreferrer">Client credentials grant flow</a>：Webhook を受信する際に使用。</li>
          <li><a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth/#authorization-code-grant-flow" target="_blank" rel="noopener noreferrer">Authorization code grant flow</a>：API を発行する際に使用。</li>
        </ul>
        <p>
          具体的にどうやって token を取得するかは<a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth/#examples-of-the-four-flows" target="_blank" rel="noopener noreferrer">Examples of the four flows</a>に書いていますが、以下にも記載します。<br/>
        </p>

        <br/>
        <span id="client_cred_grant_flow"></span>
        <h4>Client credentials grant flow</h4>
        <p>
          Client credentials grant flow では以下のような curl コマンドを発行します。<br/>
        </p>

<pre class="title"><code class="title">Client credentials grant flow example(App access token)</code></pre>
<pre><code>curl -X POST 'https://id.twitch.tv/oauth2/token' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'client_id=XXXXXX&client_secret=YYYYYY&grant_type=client_credentials'
</code></pre>

        <ul>
          <li>XXXXXX：<a href="#register_application">アプリケーションの登録</a>で取得したクライアントID</li>
          <li>YYYYYY：<a href="#register_application">アプリケーションの登録</a>で取得した秘密鍵</li>
        </ul>

        <p>
          以下の形式でレスポンスが返ってくるので、 access_token を保存する。<br/>
        </p>

<pre><code>{
  "access_token":"[発行されたトークン]",
  "expires_in":[有効期限],
  "token_type":"bearer"
}
</code></pre>


        <br/>
        <span id="auth_code_grant_flow"></span>
        <h4>Authorization code grant flow</h4>
        <p>
          Authorization code grant flow では以下のような 形式の URL をブラウザに入力します。<br/>
        </p>


<pre class="title"><code class="title">Authorization code grant flow example(User access token)</code></pre>
<pre><code>https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=XXXXXX&redirect_uri=ZZZZZZ&scope=[必要なスコープ]&state=c3ab8aa609ea11e793ae92361f002671</code></pre>

        <ul>
          <li>XXXXXX：<a href="#register_application">アプリケーションの登録</a>で取得したクライアントID</li>
          <li>ZZZZZZ：<a href="#register_application">アプリケーションの登録</a>で設定したリダイレクトURL</li>
          <li>必要なスコープ：<a href="https://dev.twitch.tv/docs/authentication/scopes/" target="_blank" rel="noopener noreferrer">リンク先を参考に必要なスコープを指定</a></li>
        </ul>

        <p>
          例として、「channel:read:polls」と「channel:manage:polls」の2つをスコープに指定する場合、URLの入力は「channel%3Amanage%3Apolls+channel%3Aread%3Apolls」として以下のようになります。<br/>
          ここで「%3A」は「:」のURLエンコードです。「+」で二つのスコープを連結しています。<br/>
        </p>

        <pre><code>https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=XXXXXX&redirect_uri=ZZZZZZ&scope=channel%3Amanage%3Apolls+channel%3Aread%3Apolls&state=c3ab8aa609ea11e793ae92361f002671</code></pre>

        <br/>
        <p>
          上記をブラウザに入力すると、 redirect_uri に指定したURLにリダイレクトされる。リダイレクト先のURLに、以下のような形式で access_token が記載されているのでそれを保存する。<br/>
        </p>

        <pre><code>[指定したリダイレクトURL]/#access_token=[発行されたトークン]&scope=[指定したスコープ]&token_type=bearer</code></pre>

        <br/>
        <p>
          スコープに指定できる具体的な値は <a href="https://dev.twitch.tv/docs/authentication/scopes/" target="_blank" rel="noopener noreferrer">Twitch API scopes</a> 参照。必要なスコープは発行する API ごとに異なる。例えば、投票を開始する API を呼び出す場合、 <a href="https://dev.twitch.tv/docs/api/polls/" target="_blank" rel="noopener noreferrer">Polls</a> を見ると「The endpoint requires a user access token with scope channel:manage:polls」とあるので、必要なスコープは「channel:manage:polls」だということがわかる。<br/>
        </p>

        <br/>
        <span id="user"></span>
        <h3 class="title">Twitch のユーザー</h3>
        <p>
          Twitch では、ユーザーを示す項目は大きく3種類あります。<br/>
          API や Webhook を使う際に理解しておく必要があります。<br/>
        </p>

        <ul>
          <li>user_name/login_name：ログインするときのid。アカウントの設定画面の日本語名称は「ユーザー名」。後から変更できる。</li>
          <li>display_name：チャット欄などに表示される名前。アカウントの設定画面の日本語名称は「表示名」。後から変更できる。設定していないユーザーもいる。</li>
          <li>user_id：Twitch が裏で採番している一意なid。通常意識しない。変更不可。</li>
        </ul>

        <p>
          呼び方は統一されていない気がしますが、項目としてはこの3つがあります。<br/>
          display_nameが設定されているユーザーの場合、チャットしたときの名前が「あああ(aaa)」と表示されます。この「あああ」が display_name で「aaa」が user_name です。<br/>
          Twitch の API や Webhook を使用するときは user_name と user_id を結構使うので、この違いは把握しておきたい。<br/>
          下記リンク先から user_name と user_id を相互に変換することができます。結構使うことはあるのでブックマークしておくと良いでしょう。<br/>

          <a href="https://www.streamweasels.com/tools/convert-twitch-username-to-user-id/" target="_blank" rel="noopener noreferrer">Convert Twitch Username to Channel ID</a><br/>
        </p>

        <br/>
        <span id="tmijs"></span>
        <h3 class="title">tmi.js × Node.js</h3>
        <p>
          event emitter<br/>
          <a href="https://tmijs.com/" target="_blank" rel="noopener noreferrer">tmi.js</a><br/>
          <a href="https://github.com/tmijs/tmi.js" target="_blank" rel="noopener noreferrer">github tmi.js</a><br/>

          <br/>
          tmi.jsで拾えるイベントの全量は以下リンク先参照。<br/>
          <a href="https://github.com/tmijs/docs/blob/gh-pages/_posts/v1.4.2/2019-03-03-Events.md" target="_blank" rel="noopener noreferrer">github tmijs/docs</a><br/>

          <br/>
          webhookと被っているものが結構ある。<br/>
          webhookよりはtmi.jsを使った方が（たぶん）早いので基本的にtmi.jsを使えばいいと思うが、raidはwebhookの方が使い勝手が良いと思います。<br/>
          tmi.js の raidだと、 display_name を設定しているユーザーの場合、display_name のみが返されるため、 user_name を取得できないからです。display_name をキーに user_name を返してくれるAPI は（たぶん）ないので、結構困ります。<br/>
          Webhookは user_name と display_name の両方を返してくれます。<br/>
          tmi.js を改造するブログ記事もありますが、外部ライブラリを改造すると、それが原因で予期せぬ挙動をすることも考えられるので、あまりお勧めできません。<br/>
          <a href="https://zenn.dev/sushat4692/scraps/7c25d4050fcb3b" target="_blank" rel="noopener noreferrer">Zenn tmi.jsでRaidのユーザ名・表示名を別々に取得したい</a><br/>
          以下は、誰かがチャットするたびに稼働する処理の例。<br/>
          <a href="https://github.com/tmijs/docs/blob/gh-pages/_posts/v1.4.2/2019-03-03-Events.md#message" target="_blank" rel="noopener noreferrer">Message</a><br/>
        </p>

<pre class="title"><code class="title">twitch_bot.js</code></pre>
<pre><code>'use strict';
import tmi from 'tmi.js';

const opts = {
  identity: {
    username: 'user_name',
    password: 'oauth:'+[<a href="#auth_code_grant_flow" style="color: blue">Authorization code grant flow</a>で取得した access_token],
  },
  channels: [
    'チャンネル名(= user_name)'
  ]
};
const twClientBot = new tmi.client(opts)

// チャットに反応
twClientBot.on('message', (channel, userstate, msg, self) => {
  if (self) return; // Ignore messages from the bot
  // 何か処理
});

// Connect to Twitch:
twClientBot.connect();
</code></pre>

        <br/>
        <p>
          user_state には以下のような情報が json 形式で入っています。<br/>
          <span style="color: yellow">json の中身変わってるっぽい</span>
        </p>

<pre><code>{
  'badges': { 'broadcaster': '1', 'warcraft': 'horde' },
  'color': '#FFFFFF',
  'display-name': 'サンプル',
  'emotes': { '25': [ '0-4' ] },
  'mod': true,
  'room-id': '[数値]',
  'subscriber': false,
  'turbo': true,
  'user-id': '[数値]',
  'user-type': 'mod',
  'emotes-raw': '25:0-4',
  'badges-raw': 'broadcaster/1,warcraft/horde',
  'username': 'sample',
  'message-type': 'chat'
}
</code></pre>

        <br/>
        <span id="webhook"></span>
        <h3 class="title">Webhook × Node.js</h3>
        <p>
          Webhook でイベントの通知を受け取るためには、まず受け取るサーバを構築する必要があります。以下リンク先で詳細に解説されていますが、ここでも記載します。<br/>
          <a href="https://dev.twitch.tv/docs/eventsub/handling-webhook-events/" target="_blank" rel="noopener noreferrer">Getting Events Using Webhook Callbacks</a><br/>
          Webhook でイベントを受け取るためには、まず以下のような形式で curl コマンドを実行する必要があります。
        </p>

<pre><code>curl -X POST -d '{
  "type":"[subscription_type]", 
  "version":"1", 
  "condition":{
    "broadcaster_user_id":"[user_id]"
  }, 
  "transport":{
    "method":"webhook", 
    "callback":"[callback_url]", 
    "secret":"[secret]"
  }
}'
-H "Content-Type: application/json" 
-H "Authorization: Bearer [access_token]" 
-H "client-id: [client_id]" 
https://api.twitch.tv/helix/eventsub/subscriptions
</code></pre>

        <br/>
        <ul>
          <li>subscription_type：<a href="https://dev.twitch.tv/docs/eventsub/eventsub-subscription-types/" target="_blank" rel="noopener noreferrer">Subscription Types</a>の Name 列。配信開始なら 'stream.online' を、チャンネルポイントの使用を受け取るなら 'channel.channel_points_custom_reward_redemption.add' を指定。</li>
          <li>user_id：イベントを受け取りたいユーザーの user_id</li>
          <li>
            callback_url：Webhook でイベントの通知を受け取りたいURL<br/>
            (https://[ホスト名]/[パス]) <span style="color: yellow">https じゃないとダメだったような？</span>
          </li>
          <li>secret：受け取ったサーバで認証に使用する値</li>
          <li>access_token：<a href="#client_cred_grant_flow">Client credentials grant flow</a> で取得した access_token</li>
          <li>client_id：<a href="#register_application">アプリケーションの登録</a>で取得したクライアントID</li>
        </ul>
        <br/>

        <p>
          上記 curl を実行すると callback_url に確認のリクエストが飛んでくる。<br/>
          リクエストヘッダーの 'Twitch-Eventsub-Message-Type' に 'webhook_callback_verification' が入ってくるので、その場合は body 部の challenge を status 200 でそのまま返せばOK。<br/>
          Webhook イベントを受け取るためのサーバ側の Node.js のコードは以下の通り（<a href="#whole">全量のコードを後に</a>載せていますが、長いので抜粋）。<br/>
        </p>

<pre class="title"><code class="title">確認のリクエストを受ける部分抜粋</code></pre>
<pre><code>app.post([パス], async (req, res) => {
  const MESSAGE_TYPE = 'Twitch-Eventsub-Message-Type'.toLowerCase();
  const messageType = req.header(MESSAGE_TYPE).toLowerCase();
  const MESSAGE_TYPE_VERIFICATION = 'webhook_callback_verification';
  // 初回認証
  if (messageType === MESSAGE_TYPE_VERIFICATION) {
    res.status(200).send(req.body.challenge);
    ...
  }
}
</code></pre>

        <br/>
        <p>
          以下の curl コマンドを実行すると、問題なく処理されているかを確認することができます。<br/>
          access_token, client_id に設定する値は先の curl コマンドの時と同じです。
        </p>

<pre><code>curl -X GET 'https://api.twitch.tv/helix/eventsub/subscriptions' \
-H 'Authorization: Bearer [access_token]' \
-H 'Client-Id: [client_id]'
</code></pre>

      <br/>
      <p>
        以下のようなレスポンスが返ってきます。 status が enabled になっていれば問題なしです。
      </p>

<pre><code>{
  "total":1,
  "data":[{
    "id":"xxxxxxxxxx",
    <span style="color:red">"status":"enabled",</span>
    "type":[指定した subscription_type],
    "version":"1",
    "condition":{
      "broadcaster_user_id":[指定した user_id]
    },
    "created_at":"yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSSSSZ",
    "transport":{
      "method":"webhook",
      "callback":[指定した callback_url]
    },
    "cost":0
  }],
  "max_total_cost":10000,"total_cost":0,"pagination":{}
}
</code></pre>

<br/>
<span id="whole"></span>
<p>
  以下が（ほぼ）全量の Node.js のコードです。Webhook イベントの通知を受け取った時の処理も記載しています。<br/>
  Twitch から送られてきたものであることを確認するため、HMAC認証のコードを入れています。これについては <a href="https://dev.twitch.tv/docs/eventsub/handling-webhook-events/#verifying-the-event-message" target="_blank" rel="noopener noreferrer">Verifying the event message</a> も参照してください。<br/>
</p>
<pre class="title"><code class="title">（ほぼ）全量</code></pre>
<pre><code>'use strict';
import crypto from 'crypto';
import {createServer} from 'http';
import express from 'express';
import bodyParser from 'body-parser';

const app = express();
app.use(bodyParser.json())

// Notification request header
const TWITCH_MESSAGE_ID = 'Twitch-Eventsub-Message-Id'.toLowerCase();
const TWITCH_MESSAGE_TIMESTAMP = 'Twitch-Eventsub-Message-Timestamp'.toLowerCase();
const TWITCH_MESSAGE_SIGNATURE = 'Twitch-Eventsub-Message-Signature'.toLowerCase();
const MESSAGE_TYPE = 'Twitch-Eventsub-Message-Type'.toLowerCase();

// Notification message types
const MESSAGE_TYPE_VERIFICATION = 'webhook_callback_verification';
const MESSAGE_TYPE_NOTIFICATION = 'notification';

// event type
const SUBSCRITION_TYPE = 'Twitch-Eventsub-Subscription-Type'.toLowerCase();

// Prepend this string to the HMAC that's created from the message
const HMAC_PREFIX = 'sha256=';

// post でリクエスト時に処理するコールバック関数指定
app.post([エンドポイント], async (req, res) => {
  let secret = getSecret();
  let hmacMsg = getHmacMessage(req);
  let hmac = HMAC_PREFIX + getHmac(secret, hmacMsg);  // Signature to compare

  // hmac認証失敗なら速攻で返す
  if (!verifyMessage(hmac, req.headers[TWITCH_MESSAGE_SIGNATURE])) {
    res.sendStatus(403);
    return
  }

  const messageType = req.header(MESSAGE_TYPE).toLowerCase();
  // 初回認証
  if (messageType === MESSAGE_TYPE_VERIFICATION) {
    res.status(200).send(req.body.challenge);
  // イベント通知
  } else if (messageType === MESSAGE_TYPE_NOTIFICATION) {
    const subscType = req.header(SUBSCRITION_TYPE).toLowerCase();
    switch (subscType) {
      // 配信開始時の処理
      case 'stream.online':
        // 何か処理
        res.sendStatus(200);
        break;
      // チャンネルポイントが使用された時の処理
      case 'channel.channel_points_custom_reward_redemption.add':
        // 何か処理
        res.sendStatus(200);
        break;
      // raid を受けた／した
      case 'channel.raid':
        // 何か処理
        res.sendStatus(200);
        break;
      // 配信終了
      case 'stream.offline':
        // 何か処理
        res.sendStatus(200);
        break;
      default:
        console.log(new Date() + ':unexpected subscription type.');
        res.sendStatus(200);
    }
  }
});

const server = createServer(app);
server.listen(8080);

function getSecret() {
  // TODO: Get your secret from secure storage. This is the secret you passed 
  // when you subscribed to the event.
  return '&lt;your secret goes here&gt;';
}

// Build the message used to get the HMAC.
function getHmacMessage(req) {
  return (req.headers[TWITCH_MESSAGE_ID] + 
    req.headers[TWITCH_MESSAGE_TIMESTAMP] + 
    JSON.stringify(req.body));
}

// Get the HMAC.
function getHmac(secret, hmacMsg) {
  return crypto.createHmac('sha256', secret)
  .update(hmacMsg)
  .digest('hex');
}

// Verify whether our hash matches the hash that Twitch passed in the header.
function verifyMessage(hmac, verifySignature) {
  return crypto.timingSafeEqual(Buffer.from(hmac), Buffer.from(verifySignature));
}
</code></pre>


        <br/>
        <span id="api"></span>
        <h3 class="title">Twitch API × Node.js</h3>
        <p>
          Twitch の API の一覧と仕様は <a href="https://dev.twitch.tv/docs/api/reference/" target="_blank" rel="noopener noreferrer">Twitch API Reference</a> 参照。リクエストパラメータやリクエストボディ、レスポンスの内容、必要なスコープがわかるようになっている。<br/>
          例として、ユーザーを Ban する Node.js の関数を作ってみます。<br/>
          user_name を引数で受け取り、<a href="https://dev.twitch.tv/docs/api/reference/#get-users" target="_blank" rel="noopener noreferrer">Get Users API</a> で user_name を元に user_id を取得し、それを使用して <a href="https://dev.twitch.tv/docs/api/reference/#ban-user" target="_blank" rel="noopener noreferrer">Ban User API</a> で ban するという流れです。<br/>
          ※access_token やクライアントID などの機密情報は、外部ファイルに json 形式などで保存した上で、そこから取得するようにしてください。<br/>
        </p>

<pre><code>async function banUser(banUserName) {
  // user_name から user_id を取得
  const get_users_url = `https://api.twitch.tv/helix/users?login=${banUserName}`
  let result = await fetch(get_users_url , {
    headers: {
      "Authorization": "Bearer " + [<a href="#auth_code_grant_flow" style="color: blue">Authorization code grant flow</a>で取得した access_token],
      "Client-Id": [<a href="#register_application" style="color: blue">アプリケーションの登録</a>で取得したクライアントID]
    },
  })

  let banUserInfo = await result.json()
  let banUserId = banUserInfo.data[0].id

  // 対象ユーザーをban
  const ban_api_url = `https://api.twitch.tv/helix/moderation/bans?broadcaster_id=[配信者のuser_id]&moderator_id=[モデレータのuser_id]`
  return await fetch(ban_api_url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + [<a href="#auth_code_grant_flow" style="color: blue">Authorization code grant flow</a>で取得した access_token],
      'Client-Id': [<a href="#register_application" style="color: blue">アプリケーションの登録</a>で取得したクライアントID]
    },
    body: JSON.stringify({
      'data': {
        'user_id': banUserId
      },
    }),
  })
}
</code></pre>


        <br/>
        <span id="twitter"></span>
        <h3 class="title">X（旧twitter） × Node.js</h3>
        <p>
          X（旧twitter）のAPIは、限定された範囲であれば無料で使用することができます。具体的には以下。
        </p>

        <ul>
          <li>月1,500、1日50ポストまで</li>
          <li>ポストとポストの削除</li>
          <li>自分のアカウントのデータの取得（フォロワー数、フォロー数など）</li>
        </ul>

        <p>
          詳しくは<a href="https://programming-zero.net/how-to-start-twitter-api-basic-and-free/" target="_blank" rel="noopener noreferrer">リンク先参照</a>。<br/>

          <br/>
          XのAPIはv1.1, v2の2つがあり、それぞれ使い分ける必要がある。
        </p>

        <ul>
          <li>v1.1：ツイートに画像や動画などのメディアを添付する場合に使用。</li>
          <li>v2：上記以外は基本的にはv2を使用。</li>
        </ul>

        <p>
          私は、X関連の機能を Node.js で実装する場合、 <a href="https://github.com/PLhery/node-twitter-api-v2/tree/065b02ad264d70e8f879184fb7130e033c659cc3" target="_blank" rel="noopener noreferrer">node-twitter-api-v2</a> というライブラリを使用しています。これを使うと簡単にv1.1とv2を切り替えることができるので便利です。実際にそのライブラリを使用したコードは以下の通り。<br/>
        </p>


<pre class="title"><code class="title">tweet.js</code></pre>
<pre><code>export async function tweetStreamStart() {
  let tweetClient = new twitter.TwitterApi({
    appKey: [api_key],
    appSecret: [api_secret],
    accessToken: [access_token],
    accessSecret: [access_secret],
  }).readWrite

  // 画像のアップロード。
  // 複数ファイルをアップロードする場合は Promise.all([]) 内で複数アップロード。
  const mediaIds = await Promise.all([
    <span style="color:red">tweetClient.v1.uploadMedia([file_path]),</span>  // v1.1で画像アップロード
  ]);

  const status = {
    text: [post_text],
    media: {media_ids: mediaIds} // Pass the media id string
  }

  <span style="color:red">tweetClient.v2.tweet(status)</span>  // v2でポスト
}
</code></pre>

        <br/>
        <p>
          ここで上記"[ ]"部分には以下の値を当てはめます。
        </p>
        <ol>
          <li>api_key：XのAPI Key</li>
          <li>api_secret：XのAPI Secret</li>
          <li>access_token：XのAccess Token</li>
          <li>access_secret：XのAccess Secret</li>
          <li>file_path：ポストするファイルのパスとファイル名</li>
          <li>post_text：ポストする文言</li>
        </ol>
        <p>
          API を使うためには 各種APIキーを取得する必要があります（上記1～4）。<br/>
          これらを取得する方法は<a href="https://zenn.dev/eito_blog/articles/a982fdb073493a" target="_blank" rel="noopener noreferrer">こちら参照</a>。<br/>

          <br/>
          これは余談ですが、（おそらくですが）2023年4月頃にXのAPI仕様が変わって以降、APIキーを取得するプロセスが変わって案外楽に取得できるようになったようです。<br/>
          無料枠で済むようなものであれば気軽に申請できるようになったようなので興味ある方はやってみてはいかがでしょうか。<br/>
        </p>

        <br/>
        <span id="obs"></span>
        <h3 class="title">OBS × Node.js</h3>
        <p>
          <a href="https://github.com/obs-websocket-community-projects/obs-websocket-js" target="_blank" rel="noopener noreferrer">obs-websocket-js</a> というライブラリを使うと Node.js から OBS の操作ができるようになります。<br/>
          <a href="https://github.com/obsproject/obs-websocket/blob/master/docs/generated/protocol.md" target="_blank" rel="noopener noreferrer">使用できる関数はこちら</a>。<br/>
          今回はチャンネルポイントの「火の鳥」を例にして説明してみます。<br/>
          <img src="img/websocker_setting1.jpg" width="500"/><br/>
          <img src="img/websocker_setting2.jpg" width="400"/><br/>
          <img src="img/websocker_setting3.jpg" width="400"/><br/>

          <br/>
          <img src="img/obs1.jpg" width="500"/><br/>
          <img src="img/obs2.jpg" width="500"/><br/>
        </p>

        <br/>
        <hr>

        <br/>
        参考サイト<br/>
        <ul>
          <li><a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth/" target="_blank" rel="noopener noreferrer">Twitch developers Getting OAuth Access Tokens</a></li>
          <li><a href="https://dev.twitch.tv/docs/authentication/" target="_blank" rel="noopener noreferrer">Twitch developers Authentication</a></li>
          <li><a href="https://dev.twitch.tv/docs/eventsub/handling-webhook-events/" target="_blank" rel="noopener noreferrer">Twitch developers Getting Events Using Webhook Callbacks</a></li>
          <li><a href="https://dev.twitch.tv/docs/api/" target="_blank" rel="noopener noreferrer">Twitch developers Twitch API</a></li>
          <li><a href="https://dev.twitch.tv/docs/authentication/scopes/" target="_blank" rel="noopener noreferrer">Twitch developers Twitch Access Token Scopes</a></li>
          <li><a href="https://dev.twitch.tv/docs/api/reference/" target="_blank" rel="noopener noreferrer">Twitch developers Twitch API Reference</a></li>
          <li><a href="https://dev.twitch.tv/docs/eventsub/eventsub-subscription-types/" target="_blank" rel="noopener noreferrer">Twitch developers Subscription Types</a></li>
          <li><a href="https://www.streamweasels.com/tools/convert-twitch-username-to-user-id/" target="_blank" rel="noopener noreferrer">Twitch Channel ID and User ID Convertor</a></li>
          <li><a href="https://tmijs.com/" target="_blank" rel="noopener noreferrer">tmi.js</a></li>
          <li><a href="https://github.com/tmijs/tmi.js" target="_blank" rel="noopener noreferrer">github tmi.js</a></li>
          <li><a href="https://github.com/tmijs/docs/blob/gh-pages/_posts/v1.4.2/2019-03-03-Events.md" target="_blank" rel="noopener noreferrer">github tmijs/docs</a></li>
          <li><a href="https://zenn.dev/sushat4692/scraps/7c25d4050fcb3b" target="_blank" rel="noopener noreferrer">Zenn tmi.jsでRaidのユーザ名・表示名を別々に取得したい</a></li>
          <li><a href="https://qiita.com/pasta04/items/750d71d41e5edd12932b" target="_blank" rel="noopener noreferrer">Qiita Twitch APIを利用してみよう</a></li>
          <li><a href="https://programming-zero.net/how-to-start-twitter-api-basic-and-free/" target="_blank" rel="noopener noreferrer">Programming ZERO Twitter API有料(Basic)、無料プラン利用開始手順※2023年9月最新</a></li>
          <li><a href="https://zenn.dev/eito_blog/articles/a982fdb073493a" target="_blank" rel="noopener noreferrer">Zenn 【2023年度最新版】Twitter API 取得方法</a></li>
          <li><a href="https://github.com/PLhery/node-twitter-api-v2/tree/065b02ad264d70e8f879184fb7130e033c659cc3" target="_blank" rel="noopener noreferrer">github node-twitter-api-v2</a></li>
          <li><a href="https://zenn.dev/temple_c_tech/scraps/72ce713752f7cd" target="_blank" rel="noopener noreferrer">Zenn Twitter-API-v2(Node.js)ライブラリでTwitter検索してみる</a></li>
        </ul>
      </section><!-- section class="box" -->

      <footer>
        <small><a href="https://taumax-github.github.io/">とあるＩＴエンジニアの知識整理</a> All Rights Reserved.</small>
        <span class="pr"><a href="https://template-party.com/" target="_blank">《Web Design:Template-Party》</a></span>
      </footer>

    </div><!--/#main-->
    </div><!--/#contents-->
    </div><!--/#container-->
  </body>

  <!--ページの上部に戻る「↑」ボタン-->
  <p class="nav-fix-pos-pagetop"><a href="#pagetop">↑</a></p>

  <!--メニュー開閉ボタン-->
  <div id="menubar_hdr" class="close"></div>
    <!--メニューの開閉処理条件設定　800px以下-->
    <script>
      if (OCwindowWidth() <= 800) {
        open_close("menubar_hdr", "menubar-s");
      }
    </script>
</html>
